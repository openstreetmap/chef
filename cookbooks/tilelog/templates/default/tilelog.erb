#!/bin/sh
set -e

if [ -z "$DATE" ]
then
  DATE=$(date -u -d "1 day ago" "+%Y-%m-%d")
fi

OUTDIR="<%= @output_dir %>"
TMPDIR=$(mktemp -d -t tilelog.XXXXXXXXX)

cd "$TMPDIR"

export AWS_ACCESS_KEY_ID="AKIASQUXHPE7JFCFMOUP"
export AWS_SECRET_ACCESS_KEY="<%= @aws_key %>"
export AWS_REGION="eu-west-1"

TILEFILE="tiles-${DATE}.txt.xz"
HOSTFILE="hosts-${DATE}.csv"
APPFILE="apps-${DATE}.csv"
COUNTRYFILE="countries-${DATE}.csv"

nice -n 19 /opt/tilelog/bin/tilelog --date "${DATE}" \
  --generate-success --generate-minimise --generate-location \
  --tile "${TILEFILE}" --host "${HOSTFILE}" --app "${APPFILE}" --country "${COUNTRYFILE}"

mv "${TILEFILE}" "${HOSTFILE}" "${APPFILE}" "${COUNTRYFILE}" "${OUTDIR}"

rm -rf "$TMPDIR"
