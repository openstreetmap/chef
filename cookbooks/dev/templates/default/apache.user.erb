# DO NOT EDIT - This file is being maintained by Chef

WSGIDaemonProcess <%= @user %>.dev.openstreetmap.org user=<%= @user %> processes=2 threads=8 restart-interval=3600 inactivity-timeout=600 graceful-timeout=60 maximum-requests=2000

<VirtualHost *:443>
	ServerName <%= @user %>.dev.openstreetmap.org
	ServerAdmin webmaster@openstreetmap.org
	ServerAlias <%= @user %>.dev.osm.org

	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/<%= @user %>.dev.openstreetmap.org.pem
	SSLCertificateKeyFile /etc/ssl/private/<%= @user %>.dev.openstreetmap.org.key

	# Remove Proxy request header to mitigate https://httpoxy.org/
	RequestHeader unset Proxy early

	UseCanonicalName Off
	DocumentRoot <%= @directory %>
	ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/

	WSGIProcessGroup <%= @user %>.dev.openstreetmap.org

	RewriteEngine on
	#LogLevel rewrite:trace2

	CustomLog /var/log/apache2/<%= @user %>.dev.openstreetmap.org-access.log combined
	ErrorLog /var/log/apache2/<%= @user %>.dev.openstreetmap.org-error.log

	RewriteCond <%= @directory %>%{REQUEST_FILENAME} -f
	RewriteRule ^/cgi-bin/(.*)$ /~<%= @user %>/cgi-bin/$1 [PT,L]

	<FilesMatch ".+\.ph(p|ps|p3|tml)$">
		SetHandler "proxy:unix:/run/php/php-<%= @user %>-fpm.sock|fcgi://127.0.0.1"
	</FilesMatch>
</VirtualHost>

<VirtualHost *:80>
	ServerName <%= @user %>.dev.openstreetmap.org
	ServerAdmin webmaster@openstreetmap.org
	ServerAlias <%= @user %>.dev.osm.org

	CustomLog /var/log/apache2/<%= @user %>.dev.openstreetmap.org-access.log combined
	ErrorLog /var/log/apache2/<%= @user %>.dev.openstreetmap.org-error.log

	RedirectPermanent /.well-known/acme-challenge/ http://acme.openstreetmap.org/.well-known/acme-challenge/
	RedirectPermanent / https://<%= @user %>.dev.openstreetmap.org/
</VirtualHost>

<Directory <%= @directory %>>
	AllowOverride AuthConfig FileInfo Indexes Options=RailsBaseURI
	Options SymLinksIfOwnerMatch Indexes Includes
	Require all granted
</Directory>

<Directory <%= @directory %>/cgi-bin>
	SetHandler cgi-script
	Options ExecCGI SymLinksIfOwnerMatch
	Require all granted
</Directory>

<Directory <%= @directory %>/wsgi-bin>
	SetHandler wsgi-script
	Options ExecCGI SymLinksIfOwnerMatch
	Require all granted
</Directory>
